# 架构设计

本文档介绍了 EVM Scanner 的系统架构、核心组件以及数据流向。

## 系统概览

EVM Scanner 是一个高性能、高可靠的以太坊（及 EVM 兼容链）日志监听工具。它采用生产者-消费者模型，通过多 RPC 节点池获取区块链数据，并支持多种下游输出。

## 核心组件

### 1. 扫描器 (Scanner)
扫描器是系统的核心驱动引擎，负责：
- 区块高度同步与进度管理。
- 批量区块日志获取。
- 应对链重组 (Reorganization) 的回退处理。
- 布隆过滤器 (Bloom Filter) 优化。

### 2. RPC 客户端池 (RPC Client Pool)
RPC 客户端池提供高可用性支持：
- **故障转移 (Failover)**：当主节点失效时，自动切换到备用节点。
- **权重管理**：通过优先级 (Priority) 控制节点的使用顺序。
- **重试机制**：内置指数退避重试，应对网络抖动。

### 3. 事件解码器 (Event Decoder)
解析原始区块链日志：
- 加载 ABI 定义。
- 将 `Topic` 和 `Data` 解码为人类可读的 JSON 结构。
- 支持多合约、多事件的并发解析。

### 4. 存储引擎 (Storage Engine)
负责持久化扫描进度（Cursor）：
- **Redis**：适用于高频更新，通常用于开发或对性能要求极高的场景。
- **Postgres**：适用于生产环境，提供更高的数据一致性保证。
- **Memory**：用于测试或一次性扫描。

### 5. 输出组件 (Sink Manager)
将处理后的事件推送到下游：
- **Webhook**：通过 HTTP POST 发送到应用服务器，支持签名验证和重试。
- **消息队列**：支持 Kafka, RabbitMQ, Redis List/PubSub。
- **数据库**：直接写入 Postgres。
- **文件与控制台**：用于日志记录和调试。

## 数据流向

1. **获取区块**：Scanner 定时轮询 RPC 节点，获取最新的区块高度。
2. **过滤日志**：根据配置的合约地址和 Topic，利用 `eth_getLogs` 或 `eth_newFilter` 获取日志。
3. **解码转换**：Decoder 将原始 Log 转换为结构化数据。
4. **进度同步**：Scanner 更新并持久化当前的扫描高度。
5. **分发输出**：Sink Manager 将数据并发推送到所有启用的输出目标。

## 故障恢复

- **程序重启**：启动时会自动从存储引擎读取上次保存的 `Cursor`，并执行 `cursor_rewind` 以确保数据不遗漏。
- **RPC 异常**：自动切换节点，若全部节点不可用则等待重试。
- **输出失败**：对于 Webhook 等组件，支持内置的重试序列，避免由于下游临时不可用导致的消息丢失。

## 性能优化

- **并发处理**：日志解码和下游推送均采用并发操作。
- **批量请求**：支持 `batch_size` 批量获取多个区块的日志。
- **节点过滤**：利用 EVM 节点的 Bloom Filter 快速过滤不感兴趣的区块，大幅减少无效请求。
